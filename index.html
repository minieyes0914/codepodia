<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‹•ç‰©æ–¹ç¨‹å¼ï¼šè­¦æ ¡ç¨‹å¼ç‰¹è¨“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX and TypeScript support in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      /* Custom scrollbar - Increased width for better accessibility */
      .custom-scrollbar::-webkit-scrollbar {
        width: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f8fafc;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 5px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-in-out;
      }
      /* Radar pulse animation for level 3 */
      @keyframes pulse-ring {
        0% { transform: scale(0.33); opacity: 0.8; }
        80%, 100% { transform: scale(1.5); opacity: 0; }
      }
      .radar-pulse {
        position: absolute;
        width: 40px;
        height: 40px;
        background: rgba(239, 68, 68, 0.4);
        border-radius: 50%;
      }
      .radar-pulse::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border: 2px solid #ef4444;
        border-radius: 50%;
        animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      }

      /* Subtle Tactical HUD Background for Coding Area */
      .coding-area-bullseye {
        background-color: #fafbfd;
        background-image: 
          /* Very Faint Concentric Circles */
          radial-gradient(circle at center, transparent 0, transparent 80px, rgba(51, 65, 85, 0.03) 81px, rgba(51, 65, 85, 0.03) 82px, transparent 83px),
          radial-gradient(circle at center, transparent 0, transparent 160px, rgba(51, 65, 85, 0.03) 161px, rgba(51, 65, 85, 0.03) 162px, transparent 163px),
          radial-gradient(circle at center, transparent 0, transparent 240px, rgba(51, 65, 85, 0.03) 241px, rgba(51, 65, 85, 0.03) 242px, transparent 243px),
          radial-gradient(circle at center, transparent 0, transparent 320px, rgba(51, 65, 85, 0.03) 321px, rgba(51, 65, 85, 0.03) 322px, transparent 323px),
          /* Light Dot Grid */
          radial-gradient(rgba(51, 65, 85, 0.1) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 24px 24px;
        background-position: center;
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
        "react-dom/client": "https://esm.sh/react-dom@^19.2.3/client",
        "react-dom": "https://esm.sh/react-dom@^19.2.3",
        "react": "https://esm.sh/react@^19.2.3"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { Play, RotateCcw, Volume2, Move, MousePointer, MessageCircle, Layers, Image as ImageIcon, Star, Trophy, AlertCircle, ArrowRight, Lightbulb, Calculator, BookOpen, CornerDownRight, User, RotateCw, Flag, Map, MapPin } from 'lucide-react';

      // --- Types ---
      type BlockType = 'event' | 'motion' | 'control' | 'looks' | 'sound' | 'sensing' | 'variable' | 'operator';

      interface BlockData {
        id: string;
        text: string;
        type: BlockType;
      }

      interface LevelData {
        id: number;
        title: string;
        description: string;
        hint: string;
        explanation: string;
        concept: string[];
        availableBlocks: BlockData[];
        solution: string[]; 
        initialScore: number;
      }

      // --- Data ---
      const LEVELS: LevelData[] = [
        {
          id: 1,
          title: "ç¬¬ä¸€é—œï¼šè­¦æ ¡å ±åˆ°",
          description: "æ–°é€²è­¦å“¡ï¼æˆ‘æ˜¯èŒ±è’‚è­¦å®˜ã€‚ä»Šå¤©æ˜¯ä½ å ±åˆ°çš„ç¬¬ä¸€å¤©ï¼Œè«‹å…ˆå‘è »ç‰›å±€é•·å±•ç¾ä½ çš„ç²¾ç¥ï¼Œå¤§è²å ±å‘Šä½ çš„åˆ°ä¾†ã€‚",
          hint: "ç¨‹å¼éƒ½éœ€è¦ä¸€å€‹èµ·é»ï¼Œæ‰¾æ‰¾çœ‹é»ƒè‰²çš„ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€ï¼Œæ¥è‘—æ¥ä¸Šç´«è‰²çš„ã€Œèªªå‡º...ã€ç©æœ¨ã€‚",
          explanation: "ç¨‹å¼åŸ·è¡Œéœ€è¦ä¸€å€‹è§¸ç™¼äº‹ä»¶ã€‚æˆ‘å€‘ä½¿ç”¨ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€ä½œç‚ºé–‹é—œï¼Œæ¥è‘—æ”¾å…¥ã€Œèªªå‡º...ã€ç©æœ¨ï¼Œé€™æ¨£ä¸€æŒ‰ä¸‹åŸ·è¡Œï¼Œä½ å°±æœƒçœ‹åˆ°æˆ‘é¦¬ä¸Šèªªè©±å›‰ï¼",
          concept: ["äº‹ä»¶(Event)", "åŸºæœ¬è…³æœ¬"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'move10', text: 'ç§»å‹• 10 é»', type: 'motion' },
            { id: 'say_start', text: 'èªªå‡ºã€ŒèŒ±è’‚è­¦å®˜ï¼Œå ±åˆ°ï¼ã€æŒçºŒ2ç§’', type: 'looks' },
            { id: 'wait_1', text: 'ç­‰å¾… 1 ç§’', type: 'control' },
            { id: 'turn15', text: 'å³è½‰ 15 åº¦', type: 'motion' }
          ],
          solution: ['flag', 'say_start']
        },
        {
          id: 2,
          title: "ç¬¬äºŒé—œï¼šå¸‚ä¸­å¿ƒé›†åˆ",
          description: "è­¦å“¡ï¼Œæ¥ç²ç·Šæ€¥é€šå ±ï¼æˆ‘å€‘å¿…é ˆç«‹åˆ»å‰å¾€å¸‚ä¸­å¿ƒå»£å ´èˆ‡å°¼å…‹æœƒåˆã€‚è«‹ä½ è¨­å®šå°èˆªç³»çµ±ï¼Œè®“å·¡é‚è»Šèƒ½ç¬é–“æŠµé”æŒ‡å®šä½ç½®ã€‚",
          hint: "åœ°åœ–çš„æ­£ä¸­å¤®åº§æ¨™æ˜¯ X=0, Y=0ã€‚è©¦è‘—ç”¨è—è‰²çš„ã€Œå®šä½åˆ° x:0 y:0ã€ç©æœ¨ç›´æ¥å‚³é€éå»ã€‚",
          explanation: "åœ¨æ•¸ä½ä¸–ç•Œçš„åº§æ¨™ä¸­ï¼Œä¸­å¿ƒé»å°±æ˜¯ x:0, y:0ã€‚ä½¿ç”¨ã€Œå®šä½åˆ° x:0 y:0ã€ç©æœ¨ï¼Œå°±èƒ½ä¸ç®¡è­¦è»ŠåŸæœ¬åœ¨å“ªè£¡ï¼Œç²¾æº–åœ°æŠŠå®ƒå‚³é€åˆ°åœ°åœ–æ­£ä¸­å¤®ã€‚",
          concept: ["åº§æ¨™(X,Y)", "å®šä½"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'goto_random', text: 'å®šä½åˆ° éš¨æ©Ÿä½ç½®', type: 'motion' },
            { id: 'goto_0_0', text: 'å®šä½åˆ° x:0 y:0', type: 'motion' },
            { id: 'change_x', text: 'x æ”¹è®Š 10', type: 'motion' },
            { id: 'change_y', text: 'y æ”¹è®Š 10', type: 'motion' },
            { id: 'say_pos', text: 'èªªå‡ºã€ŒæŠµé”å»£å ´ã€', type: 'looks' }
          ],
          solution: ['flag', 'goto_0_0']
        },
        {
          id: 3,
          title: "ç¬¬ä¸‰é—œï¼šå‹•æ…‹å·¡é‚",
          description: "è­¦å“¡ï¼Œé–‹å§‹åŸ·è¡Œå·¡é‚ä»»å‹™ï¼è«‹ä½ é§•é§›å·¡é‚è»Šå·¡è¦–åŸå¸‚çš„æ¯å€‹è§’è½ã€‚æŒ‡æ®ä¸­å¿ƒæœƒç™¼å‡ºå¼•å°è¨Šè™Ÿï¼Œè«‹ä½ ç¢ºä¿è­¦è»Šèƒ½ç·Šéš¨å°èˆªè¨Šè™Ÿå‰é€²ã€‚",
          hint: "å°èˆªè¨Šè™Ÿæœƒè·Ÿéš¨ä½ çš„é¼ æ¨™ã€‚è¦è®“è»Šå­æŒçºŒè¿½è¹¤ï¼Œéœ€è¦ä½¿ç”¨æ©˜è‰²çš„ã€Œé‡è¤‡ç„¡é™æ¬¡ã€ç©æœ¨åŒ…ä½ã€Œé¢æœé¼ æ¨™ã€èˆ‡ã€Œç§»å‹•ã€ã€‚",
          explanation: "æˆ‘å€‘ä½¿ç”¨ã€é¢æœé¼ æ¨™ã€æŒ‡ä»¤ä¾†æ¨¡æ“¬å°èˆªç³»çµ±ã€‚åœ¨ Scratch ä¸­ï¼Œé€™èƒ½è®“è§’è‰²è¿½è¹¤æ»‘é¼ æˆ–æ‰‹æŒ‡çš„ä½ç½®ï¼Œè®“æˆ‘èƒ½ç²¾æº–åœ°è·Ÿéš¨ä½ çš„å°èˆªå¼•å°å‰é€²ã€‚",
          concept: ["è¿´åœˆ(Loop)", "å‹•æ…‹è¿½è¹¤ (é¢æœé¼ æ¨™)"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'point_mouse', text: 'é¢æœ [é¼ æ¨™] å‘', type: 'motion' },
            { id: 'move_steps', text: 'ç§»å‹• 5 é»', type: 'motion' },
            { id: 'wait_1', text: 'ç­‰å¾… 1 ç§’', type: 'control' },
            { id: 'bounce', text: 'ç¢°åˆ°é‚Šç·£å°±åå½ˆ', type: 'motion' },
            { id: 'turn_15', text: 'å³è½‰ 15 åº¦', type: 'motion' }
          ],
          solution: ['flag', 'forever', 'point_mouse', 'move_steps']
        },
        {
          id: 4,
          title: "ç¬¬å››é—œï¼šè¿½æ•å¨æ–¯é “",
          description: "è­¦å“¡ï¼Œç™¼ç¾å·èµ°æ´‹è”¥é ­çš„å°å·å¨æ–¯é “äº†ï¼æˆ‘å€‘å¿…é ˆå±•é–‹æ””æˆªã€‚è«‹ä½ åœ¨æˆåŠŸé€®æ•å¾Œï¼Œå°ä»–å¤§å–Šå£è™Ÿã€åŒæ­¥é€šçŸ¥å…¨åŸè­¦ç¶²æ”¯æ´ï¼Œä¸¦å°‡ä»–é€å¾€å¤§ç‰¢ã€‚",
          hint: "ä½¿ç”¨ã€Œå¦‚æœ...é‚£éº¼ã€æª¢æŸ¥æ˜¯å¦ã€Œç¢°åˆ°å¨æ–¯é “ã€ã€‚æ¢ä»¶æˆç«‹å¾Œä¾åºåŸ·è¡Œï¼šèªªè©±ã€å»£æ’­è¨Šæ¯ï¼Œæœ€å¾Œæ›´æ›èƒŒæ™¯ç‚ºç‰¢æˆ¿ã€‚",
          explanation: "é€™æ˜¯æ¨™æº–çš„ã€Œç¢°æ’åµæ¸¬ã€ã€‚æˆ‘å€‘æŠŠã€Œå¦‚æœ...é‚£éº¼ã€æ”¾åœ¨ç„¡é™è¿´åœˆè£¡ï¼Œéš¨æ™‚æª¢æŸ¥æ˜¯å¦æŠ“åˆ°å°å·ã€‚ä¸€æ—¦æ¢ä»¶æˆç«‹ï¼Œå°±æœƒåŸ·è¡Œé€®æ•æµç¨‹ï¼",
          concept: ["åµæ¸¬(Sensing)", "å»£æ’­", "æ¢ä»¶åˆ¤æ–·"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'if_touching', text: 'å¦‚æœ <ç¢°åˆ° å¨æ–¯é “ > é‚£éº¼', type: 'control' },
            { id: 'say_stop', text: 'èªªå‡ºã€Œç«™ä½ï¼ã€æŒçºŒ2ç§’', type: 'looks' },
            { id: 'broadcast', text: 'å»£æ’­è¨Šæ¯ã€Œé€®æ•ã€', type: 'event' },
            { id: 'switch_bg', text: 'èƒŒæ™¯æ›æˆã€Œè­¦å±€ç‰¢æˆ¿ã€', type: 'looks' },
            { id: 'wait_1', text: 'ç­‰å¾… 1 ç§’', type: 'control' },
            { id: 'turn_15', text: 'å³è½‰ 15 åº¦', type: 'motion' }
          ],
          solution: ['flag', 'forever', 'if_touching', 'say_stop', 'broadcast', 'switch_bg']
        },
        {
          id: 5,
          title: "ç¬¬äº”é—œï¼šè’é›†è­‰æ“š",
          description: "è­¦å“¡ï¼Œå°¼å…‹åœ¨ç¾å ´ç™¼ç¾äº†å¤§é‡æ•£è½çš„é—œéµç·šç´¢ã€‚è«‹ä½ è² è²¬è¨˜éŒ„è’é›†éç¨‹ï¼šåœ¨å·¡é‚å‰ç¢ºä¿è¨˜éŒ„å™¨å·²æ¸…é™¤ã€‚æ¯ç•¶æˆ‘æ‹¾å–ç·šç´¢æ™‚ï¼Œç³»çµ±éœ€ç™¼å‡ºç¢ºèªéŸ³æ•ˆä¸¦è«‹ä½ å³æ™‚æ›´æ–°æ•¸æ“šã€‚",
          hint: "é€™æ˜¯ã€Œè®Šæ•¸ã€çš„æ‡‰ç”¨ã€‚ä¸€é–‹å§‹å…ˆå°‡è®Šæ•¸ã€Œè¨­ç‚º 0ã€ã€‚åœ¨ç„¡é™è¿´åœˆä¸­åµæ¸¬ã€Œç¢°åˆ°çˆªå­å†°æ£’ã€ï¼Œå‰‡åŸ·è¡Œæ’­æ”¾éŸ³æ•ˆä¸¦å°‡è®Šæ•¸ã€Œæ”¹è®Š 1ã€ã€‚",
          explanation: "è®Šæ•¸å°±åƒä¸€å€‹è¨ˆåˆ†æ¿ã€‚ç•¶æˆ‘å€‘åµæ¸¬åˆ°ç¢°åˆ°å†°æ£’æ™‚ï¼ŒåŒæ™‚åŸ·è¡Œã€Œæ’­æ”¾éŸ³æ•ˆã€å’Œã€Œè®Šæ•¸æ”¹è®Š 1ã€ï¼Œé€™æ¨£å°±èƒ½ç´€éŒ„æˆ‘å€‘è’é›†äº†å¤šå°‘è­‰æ“šã€‚",
          concept: ["è®Šæ•¸(Variable)", "è¨ˆåˆ†æ©Ÿåˆ¶"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'if_touching_item', text: 'å¦‚æœ <ç¢°åˆ° çˆªå­å†°æ£’ > é‚£éº¼', type: 'control' },
            { id: 'change_score', text: 'è®Šæ•¸ [è­‰æ“š] æ”¹è®Š 1', type: 'variable' },
            { id: 'play_sound', text: 'æ’­æ”¾éŸ³æ•ˆã€Œå•µã€', type: 'sound' },
            { id: 'set_score', text: 'è®Šæ•¸ [è­‰æ“š] è¨­ç‚º 0', type: 'variable' },
            { id: 'hide', text: 'éš±è—', type: 'looks' }
          ],
          solution: ['flag', 'set_score', 'forever', 'if_touching_item', 'play_sound', 'change_score']
        },
        {
          id: 6,
          title: "ç¬¬å…­é—œï¼šåŸç•Œå·¡é‚",
          description: "è­¦å“¡ï¼Œæˆ‘å€‘æ­£åœ¨å·¡é‚é›¨æ—å€é‚Šç•Œã€‚æŠµé”é‚Šå¢ƒå“¨æ‰€å¾Œè«‹ä½ å…ˆå°è·¯äººç™¼å‡ºè­¦å ±ï¼Œä¸¦è¨­å®šè‡ªå‹•å·¡é‚æ¨¡å¼ï¼Œè®“å·¡é‚è»Šèƒ½åœ¨é‚Šç•Œå…§æŒçºŒå·¡è¦–ï¼Œä¸”åœ¨ç¢°åˆ°åœ°å€é‚Šç·£æ™‚èƒ½è‡ªå‹•è½‰å‘ã€‚",
          hint: "å…ˆã€Œå®šä½åˆ° x:200 y:0ã€ä¸¦æ’­æ”¾éŸ³æ•ˆã€‚æ¥è‘—åœ¨ã€Œé‡è¤‡ç„¡é™æ¬¡ã€è£¡æ”¾å…¥ã€Œç§»å‹•ã€èˆ‡ã€Œç¢°åˆ°é‚Šç·£å°±åå½ˆã€ã€‚",
          explanation: "ç‚ºäº†ä¸è®“è­¦è»Šé–‹å‡ºåœ°åœ–ï¼ŒScratch æä¾›äº†ä¸€å€‹å¾ˆå¥½ç”¨çš„ç©æœ¨ã€Œç¢°åˆ°é‚Šç·£å°±åå½ˆã€ã€‚æŠŠå®ƒæ”¾åœ¨ç§»å‹•ç©æœ¨å¾Œé¢ï¼Œå°±èƒ½ç¢ºä¿æˆ‘æ°¸é åœ¨ç®¡è½„ç¯„åœå…§ï¼",
          concept: ["å‹•ä½œ", "é‚Šç•Œåµæ¸¬"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'goto_edge', text: 'å®šä½åˆ° x:200 y:0', type: 'motion' },
            { id: 'play_ouch', text: 'æ’­æ”¾éŸ³æ•ˆã€Œè­¦å‘Šè²ã€ç›´åˆ°çµæŸ', type: 'sound' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'move_10', text: 'ç§»å‹• 10 é»', type: 'motion' },
            { id: 'bounce', text: 'ç¢°åˆ°é‚Šç·£å°±åå½ˆ', type: 'motion' },
            { id: 'set_x_0', text: 'x è¨­ç‚º 0', type: 'motion' },
            { id: 'say_ouch', text: 'èªªå‡ºã€Œå“å‘€!ã€', type: 'looks' }
          ],
          solution: ['flag', 'goto_edge', 'play_ouch', 'forever', 'move_10', 'bounce']
        },
        {
          id: 7,
          title: "ç¬¬ä¸ƒé—œï¼šæœ€ä½³æ‹æª”",
          description: "è­¦å“¡ï¼Œå±•ç¾é»˜å¥‘çš„æ™‚åˆ»åˆ°äº†ï¼è«‹ä½ å”åŠ©æˆ‘å’Œå°¼å…‹åŒæ­¥å±•é–‹è¡Œå‹•ï¼šç”±æˆ‘è² è²¬é§•é§›è­¦è»Šè¿½æ•å«ŒçŠ¯ï¼ŒåŒæ™‚è®“å°¼å…‹åœ¨å¾Œåº§æ“ä½œç„¡ç·šé›»å‘¼å«æ”¯æ´ã€‚",
          hint: "è¦è®“å¤šå€‹è¡Œå‹•ã€ŒåŒæ™‚ã€ç™¼ç”Ÿï¼Œå¯ä»¥å»ºç«‹å¤šå€‹ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€çš„è…³æœ¬ï¼Œåˆ†åˆ¥æ§åˆ¶ç§»å‹•èˆ‡æ’­æ”¾è²éŸ³ã€‚",
          explanation: "é€™å°±æ˜¯ã€Œå¹³è¡Œè™•ç†ã€ï¼å°±åƒæˆ‘åœ¨è·‘çš„æ™‚å€™ï¼Œå°¼å…‹åŒæ™‚åœ¨èªªè©±ã€‚åœ¨ç¨‹å¼è£¡ï¼Œæˆ‘å€‘å¯ä»¥å¯«å¥½å¹¾å€‹ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€çš„è…³æœ¬ï¼Œå®ƒå€‘æœƒåŒæ™‚ä¸€èµ·åŸ·è¡Œã€‚",
          concept: ["å¹³è¡Œè™•ç†", "å¤šè…³æœ¬"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'move_10', text: 'ç§»å‹• 10 é»', type: 'motion' },
            { id: 'play_radar', text: 'æ’­æ”¾éŸ³æ•ˆã€Œç„¡ç·šé›»ã€ç›´åˆ°çµæŸ', type: 'sound' },
            { id: 'wait_1', text: 'ç­‰å¾… 1 ç§’', type: 'control' },
            { id: 'turn_15', text: 'å³è½‰ 15 åº¦', type: 'motion' }
          ],
          solution: ['flag', 'forever', 'move_10', 'flag', 'forever', 'play_radar']
        },
        {
          id: 8,
          title: "ç¬¬å…«é—œï¼šæ½›å…¥è¡Œå‹•",
          description: "è­¦å“¡ï¼ŒåŸ·è¡Œç§˜å¯†æ½›å…¥è¡Œå‹•ï¼ç‚ºäº†é¿å…é©šå‹•ç›®æ¨™ï¼Œè«‹ä½ è®“å·¡é‚è»Šç·©æ…¢åœ°ç§»å‹•åˆ°æŒ‡å®šé»ï¼Œå°±ä½å¾Œè«‹ç¨å¾…ç‰‡åˆ»ï¼Œç¢ºèªç’°å¢ƒå®‰å…¨å¾Œå†é€²è¡Œå›å ±ã€‚",
          hint: "ä½¿ç”¨è—è‰²çš„ã€Œæ»‘è¡Œåˆ°...ã€ç©æœ¨è¨­å®šæ…¢é€Ÿç§»å‹•ï¼ˆä¾‹å¦‚ 2 ç§’ï¼‰ï¼Œåˆ°é”å¾ŒåŠ å…¥ã€Œç­‰å¾… 1 ç§’ã€å†æ¥ä¸Šèªªè©±ç©æœ¨ã€‚",
          explanation: "ã€Œæ»‘è¡Œã€ç©æœ¨å¯ä»¥æ§åˆ¶ç§»å‹•çš„æ™‚é–“ï¼Œå‰µé€ å¹³æ»‘çš„ç§»å‹•æ•ˆæœï¼Œé©åˆç”¨ä¾†åšéå ´å‹•ç•«æˆ–æ½›å…¥ä»»å‹™ã€‚ç­‰å¾…ç©æœ¨å‰‡ç”¨ä¾†æ§åˆ¶ç¯€å¥ã€‚",
          concept: ["æ»‘è¡Œ(Glide)", "åº§æ¨™ç§»å‹•", "ç­‰å¾…"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'glide', text: 'åœ¨ 2 ç§’å…§æ»‘è¡Œåˆ° x:0 y:-100', type: 'motion' },
            { id: 'wait_1', text: 'ç­‰å¾… 1 ç§’', type: 'control' },
            { id: 'say_success', text: 'èªªå‡ºã€Œå°±ä½å®Œç•¢ã€', type: 'looks' },
            { id: 'goto', text: 'å®šä½åˆ° x:0 y:-100', type: 'motion' },
            { id: 'change_y', text: 'y æ”¹è®Š -10', type: 'motion' }
          ],
          solution: ['flag', 'glide', 'wait_1', 'say_success']
        },
        {
          id: 9,
          title: "ç¬¬ä¹é—œï¼šåœ°éµå±æ©Ÿ",
          description: "è­¦å“¡ï¼Œåœ°éµç³»çµ±é­åˆ°é§­å®¢æ§åˆ¶ï¼Œè»Šå»‚æ­£åœ¨è»Œé“ä¸Šå¤±æ§ç‹‚å¥”ï¼è«‹ä½ å•Ÿå‹•ç·Šæ€¥é˜²è­·å”è­°ï¼šä¸€æ—¦åµæ¸¬åˆ°è»Šå»‚èˆ‡éšœç¤™ç‰©ç™¼ç”Ÿç¢°æ’ï¼Œè«‹ç«‹å³çµ‚æ­¢æ‰€æœ‰é‹è¡Œã€‚",
          hint: "åœ¨ã€Œé‡è¤‡ç„¡é™æ¬¡ã€ä¸­è®“è»Šå­ã€Œå®šä½åˆ°éš¨æ©Ÿä½ç½®ã€ï¼Œä¸¦æ”¾å…¥ã€Œå¦‚æœ...é‚£éº¼ã€åˆ¤æ–·æ˜¯å¦ã€Œç¢°åˆ°éšœç¤™ç‰©ã€ï¼Œè‹¥æ˜¯å‰‡åŸ·è¡Œã€Œåœæ­¢å…¨éƒ¨ã€ã€‚",
          explanation: "ç·Šæ€¥åœæ­¢æŒ‰éˆ•å¾ˆé‡è¦ï¼æŠŠã€Œå¦‚æœç¢°åˆ°...é‚£éº¼åœæ­¢å…¨éƒ¨ã€æ”¾åœ¨è¿´åœˆè£¡ï¼Œç¨‹å¼å°±æœƒä¸æ–·ç›£æ§å®‰å…¨ã€‚ä¸€æ—¦ç™¼ç”Ÿç¢°æ’ï¼Œç«‹åˆ»çµ‚æ­¢æ‰€æœ‰å‹•ä½œã€‚",
          concept: ["æ¢ä»¶åˆ¤æ–·(If...Then)", "åœæ­¢ç¨‹å¼"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'goto_random', text: 'å®šä½åˆ° éš¨æ©Ÿä½ç½®', type: 'motion' },
            { id: 'if_touching_base', text: 'å¦‚æœ <ç¢°åˆ° éšœç¤™ç‰© > é‚£éº¼', type: 'control' },
            { id: 'stop_all', text: 'åœæ­¢ [å…¨éƒ¨]', type: 'control' },
            { id: 'move_10', text: 'ç§»å‹• 10 é»', type: 'motion' },
            { id: 'repeat_until', text: 'é‡è¤‡ç›´åˆ° <...>', type: 'control' }
          ],
          solution: ['flag', 'forever', 'goto_random', 'if_touching_base', 'stop_all']
        },
        {
          id: 10,
          title: "ç¬¬åé—œï¼šå¿—ç¾šå§å§æ¼”å”±æœƒ",
          description: "æ¡ˆä»¶å®Œç¾ç ´ç²ï¼Œå…¨åŸéƒ½åœ¨æ…¶ç¥ï¼å¿—ç¾šå§å§æº–å‚™èˆ‰è¾¦ä¸€å ´ç››å¤§çš„æ¼”å‡ºã€‚è­¦å“¡ï¼Œè«‹ä½ å¹«å¿™å®Œæˆå…©ä»¶äº‹ï¼šé¦–å…ˆï¼Œè«‹è®“æ­¡å¿«çš„æ¨‚æ›²å…¨ç¨‹æ’­é€ä¸åœæ­‡ï¼›æ¥è‘—ï¼Œè«‹æŒ‡å°å¥¹å±•ç¾ä¸€æ®µæœ€è€€çœ¼çš„èˆè¹ˆå‹•ä½œï¼Œä¸¦åœ¨ä¸€æ®µèˆè¹ˆå…¨éƒ¨å®Œæˆæ™‚ï¼Œå¤§è²å–Šå‡ºå£è™Ÿä¾†å‘å¤§å®¶è‡´æ„ï¼",
          hint: "ä½¿ç”¨å…©å€‹å¹³è¡Œè…³æœ¬ï¼ˆå…©é¢ç¶ æ——ï¼‰ã€‚ä¸€å€‹è² è²¬ã€Œé‡è¤‡ç„¡é™æ¬¡ã€æ’­æ”¾éŸ³æ¨‚ï¼Œå¦ä¸€å€‹å‰‡å…ˆç”¨ã€Œé‡è¤‡ 10 æ¬¡ã€åŒ…ä½ã€Œä¸‹ä¸€å€‹é€ å‹ã€èˆ‡ã€Œç­‰å¾…ã€ï¼Œæœ€å¾Œæ‰æ¥ä¸Šã€Œèªªå‡ºã€ç©æœ¨ã€‚",
          explanation: "ç‚ºäº†è®“ã€Œå£è™Ÿã€ç™¼ç”Ÿåœ¨è·³èˆçµæŸå¾Œï¼Œå£è™Ÿç©æœ¨å¿…é ˆæ¥åœ¨ã€Œé‡è¤‡ 10 æ¬¡ã€è¿´åœˆçš„ä¸‹æ–¹ã€‚è€Œç‚ºäº†è®“éŸ³æ¨‚ä¸è¢«èˆè¹ˆçš„ã€Œç­‰å¾…ã€ç©æœ¨å¡ä½ï¼ŒéŸ³æ¨‚å¿…é ˆæ”¾åœ¨å¦ä¸€å€‹ç¨ç«‹çš„ç¶ æ——è…³æœ¬ä¸­åŒæ­¥åŸ·è¡Œã€‚",
          concept: ["ç¶œåˆæ‡‰ç”¨", "å¹³è¡Œè™•ç†", "åºåˆ—é‚è¼¯"],
          initialScore: 10,
          availableBlocks: [
            { id: 'flag', text: 'ç•¶ âš‘ è¢«é»æ“Š', type: 'event' },
            { id: 'forever', text: 'é‡è¤‡ç„¡é™æ¬¡', type: 'control' },
            { id: 'repeat_10', text: 'é‡è¤‡ 10 æ¬¡', type: 'control' },
            { id: 'next_costume', text: 'é€ å‹æ›æˆ ä¸‹ä¸€å€‹', type: 'looks' },
            { id: 'play_music', text: 'æ’­æ”¾éŸ³æ•ˆã€ŒTry Everythingã€ç›´åˆ°çµæŸ', type: 'sound' },
            { id: 'wait_05', text: 'ç­‰å¾… 0.5 ç§’', type: 'control' },
            { id: 'say_ya', text: 'èªªå‡ºã€ŒCodepodia Forever!ã€æŒçºŒ2ç§’', type: 'looks' },
            { id: 'turn_15', text: 'å³è½‰ 15 åº¦', type: 'motion' }
          ],
          solution: ['flag', 'forever', 'play_music', 'flag', 'repeat_10', 'next_costume', 'wait_05', 'say_ya']
        }
      ];

      // --- Helper Functions ---

      const isContainerBlock = (blockId) => {
        return ['forever', 'if_touching', 'if_touching_item', 'if_touching_base', 'repeat_until', 'repeat_10'].includes(blockId);
      };

      const isHatBlock = (blockId) => {
        return ['flag', 'key_space'].includes(blockId);
      };

      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      const splitIntoScripts = (ids) => {
        const scripts = [];
        let currentScript = [];
        for (const id of ids) {
          if (isHatBlock(id) && currentScript.length > 0) {
            scripts.push(currentScript);
            currentScript = [];
          }
          currentScript.push(id);
        }
        if (currentScript.length > 0) scripts.push(currentScript);
        return scripts;
      };

      const areScriptsEqual = (s1, s2) => {
        if (s1.length !== s2.length) return false;
        return s1.every((val, index) => val === s2[index]);
      };

      const playSoundEffect = (type) => {
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (!AudioContext) return;
          const ctx = new AudioContext();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          const now = ctx.currentTime;
          if (type === 'pop') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
          }
        } catch (e) {
          console.error("Audio play failed", e);
        }
      };

      // --- Components ---

      const Block = ({ block, onClick, isSelected, isContainer = false }) => {
        const getColors = (type) => {
          switch (type) {
            case 'event': return 'bg-yellow-400 border-yellow-600 text-yellow-900';
            case 'motion': return 'bg-blue-500 border-blue-700 text-white';
            case 'control': return 'bg-orange-400 border-orange-600 text-white';
            case 'looks': return 'bg-purple-500 border-purple-700 text-white';
            case 'sound': return 'bg-pink-500 border-pink-700 text-white';
            case 'sensing': return 'bg-cyan-500 border-cyan-700 text-white';
            case 'variable': return 'bg-orange-500 border-orange-700 text-white';
            case 'operator': return 'bg-green-500 border-green-700 text-white';
            default: return 'bg-gray-400';
          }
        };
        const baseClasses = `${getColors(block.type)} px-3 py-2 rounded-md cursor-pointer shadow-sm border-l-4 font-medium text-sm select-none transition-transform active:scale-95 ${isSelected ? 'opacity-50' : 'hover:brightness-110'} flex items-center gap-2 relative z-10`;
        const containerClasses = isContainer ? 'rounded-b-none mb-0' : 'mb-2';
        return (
          <div className="relative">
            <div onClick={onClick} className={`${baseClasses} ${containerClasses}`}>
              {block.type === 'event' && <Play size={14} />}
              {block.type === 'motion' && <Move size={14} />}
              {block.type === 'control' && <RotateCcw size={14} />}
              {block.type === 'looks' && <ImageIcon size={14} />}
              {block.type === 'sound' && <Volume2 size={14} />}
              {block.type === 'sensing' && <MousePointer size={14} />}
              {block.type === 'variable' && <Calculator size={14} />}
              {block.type === 'operator' && <Calculator size={14} />}
              {block.text}
              {isContainer && <CornerDownRight size={16} className="ml-auto opacity-50" />}
            </div>
          </div>
        );
      };

      // --- Main App ---

      function App() {
        const [currentLevelIdx, setCurrentLevelIdx] = useState(0);
        const [scriptArea, setScriptArea] = useState([]);
        const [totalScore, setTotalScore] = useState(0);
        const [gameState, setGameState] = useState('intro');
        const [feedback, setFeedback] = useState("");
        const [showAnimation, setShowAnimation] = useState(false);
        const [showHint, setShowHint] = useState(false); 
        const [attempts, setAttempts] = useState(0);
        const [isLevelFailed, setIsLevelFailed] = useState(false);
        const [shuffledBlocks, setShuffledBlocks] = useState([]);
        const [costumeFrame, setCostumeFrame] = useState(0);
        const [playerName, setPlayerName] = useState("");
        const [autoMousePos, setAutoMousePos] = useState({ x: 50, y: 50 });
        const [rotation, setRotation] = useState(0);

        const currentLevel = LEVELS[currentLevelIdx];
        
        // åˆ¤æ–·æ­¤é—œå¡æ˜¯å¦ç‚ºå¤šå€‹è…³æœ¬çµ„åˆè€Œæˆ
        const isMultiScriptLevel = currentLevel.solution.filter(id => isHatBlock(id)).length > 1;

        useEffect(() => {
          setShuffledBlocks(shuffleArray(currentLevel.availableBlocks));
        }, [currentLevelIdx, currentLevel.availableBlocks]);

        useEffect(() => {
          if (currentLevel.id === 10 && showAnimation) {
            const interval = setInterval(() => {
              setCostumeFrame(prev => prev + 1);
            }, 500); 
            return () => clearInterval(interval);
          }
        }, [currentLevel.id, showAnimation]);

        useEffect(() => {
          if (currentLevel.id === 3 && showAnimation) {
            let angle = 0;
            const interval = setInterval(() => {
              angle += 0.05;
              const x = 50 + 35 * Math.cos(angle);
              const y = 50 + 35 * Math.sin(angle);
              const rot = (angle * 180 / Math.PI) + 90 + 90; 
              setAutoMousePos({ x, y });
              setRotation(rot);
            }, 20);
            return () => clearInterval(interval);
          }
        }, [currentLevel.id, showAnimation]);

        const addToScript = (block) => {
          if (gameState !== 'playing') return;
          setScriptArea([...scriptArea, block]);
        };

        const removeFromScript = (index) => {
          if (gameState !== 'playing') return;
          const newScript = [...scriptArea];
          newScript.splice(index, 1);
          setScriptArea(newScript);
        };

        const clearScript = () => {
          if (gameState === 'success') return;
          setScriptArea([]);
        };

        const checkAnswer = () => {
          const userIds = scriptArea.map(b => b.id);
          const solutionIds = currentLevel.solution;
          const userScripts = splitIntoScripts(userIds);
          const solutionScripts = splitIntoScripts(solutionIds);
          let isCorrect = true;
          if (userScripts.length !== solutionScripts.length) {
            isCorrect = false;
          } else {
            const remainingSolutions = [...solutionScripts];
            for (const uScript of userScripts) {
              const matchIndex = remainingSolutions.findIndex(sScript => areScriptsEqual(uScript, sScript));
              if (matchIndex === -1) {
                isCorrect = false;
                break;
              } else {
                remainingSolutions.splice(matchIndex, 1);
              }
            }
          }
          if (isCorrect) {
            setGameState('success');
            setShowAnimation(true);
            if (currentLevel.id === 5) playSoundEffect('pop');
            if (!isLevelFailed) {
              setFeedback("ç¨‹å¼åŸ·è¡ŒæˆåŠŸï¼(ç²å¾— 10 åˆ†)");
              setTotalScore(prev => prev + 10);
            } else {
              setFeedback("ç¨‹å¼åŸ·è¡ŒæˆåŠŸã€‚");
            }
          } else {
            const newAttempts = attempts + 1;
            setAttempts(newAttempts);
            if (newAttempts >= 3) {
              setIsLevelFailed(true);
              setFeedback("å·²å˜—è©¦éŒ¯èª¤ 3 æ¬¡ã€‚è »ç‰›å±€é•·æŠŠæ­£ç¢ºçš„ç¨‹å¼é †åºçµ¦ä½ äº†ï¼ˆæœ¬é—œä¸åŠ åˆ†ï¼‰ã€‚");
              const solutionBlocks = currentLevel.solution.map(id => 
                currentLevel.availableBlocks.find(b => b.id === id)
              ).filter(Boolean);
              setScriptArea(solutionBlocks);
              setGameState('success');
              setShowAnimation(true);
            } else {
              setFeedback(`ç¨‹å¼å…§å®¹æˆ–å…§éƒ¨é †åºæœ‰èª¤ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚(å‰©é¤˜å˜—è©¦ï¼š${3 - newAttempts})`);
            }
          }
        };

        const nextLevel = () => {
          if (currentLevelIdx < LEVELS.length - 1) {
            setCurrentLevelIdx(prev => prev + 1);
            setScriptArea([]);
            setGameState('playing');
            setFeedback("");
            setShowAnimation(false);
            setShowHint(false);
            setAttempts(0);
            setIsLevelFailed(false);
          } else {
            setGameState('complete');
          }
        };

        const startGame = () => {
          setGameState('playing');
          setCurrentLevelIdx(0);
          setTotalScore(0);
          setScriptArea([]);
          setFeedback("");
          setShowHint(false);
          setAttempts(0);
          setIsLevelFailed(false);
        };

        const getRenderedScript = () => {
          let currentIndent = 0;
          return scriptArea.map((block) => {
            if (isHatBlock(block.id)) currentIndent = 0;
            const isContainer = isContainerBlock(block.id);
            const renderData = { ...block, indentLevel: currentIndent, isContainer };
            if (isContainer) currentIndent += 1;
            return renderData;
          });
        };

        const renderedScript = getRenderedScript();

        // è¼”åŠ©å‡½å¼ï¼šæ ¹æ“š playerName èª¿æ•´ç°¡å ±æ–‡å­—
        const getDynamicDescription = (desc) => {
          if (!playerName) return desc;
          // å°‡åå­—åŠ åœ¨ã€Œè­¦å“¡ã€å‰é¢
          return desc.replace(/(æ–°é€²)?è­¦å“¡/g, (match) => `${playerName} ${match}`);
        };

        const renderGameStage = () => {
          let bgClass = "bg-gradient-to-b from-sky-300 to-sky-100";
          if (currentLevel.id === 4 && !showAnimation) bgClass = "bg-gradient-to-b from-slate-800 to-slate-900";
          if (currentLevel.id === 4 && showAnimation) bgClass = "bg-slate-800";
          if (currentLevel.id === 8) bgClass = "bg-gradient-to-b from-slate-800 to-slate-900";
          if (currentLevel.id === 6) bgClass = "bg-[url('https://images.unsplash.com/photo-1511497584788-876760111969?q=80&w=600&auto=format&fit=crop')] bg-cover bg-center";

          return (
            <div className={`w-full h-full ${bgClass} relative overflow-hidden flex items-center justify-center border-4 border-slate-700 transition-all duration-1000 ${showAnimation ? 'border-green-400' : ''}`}>
              {currentLevel.id === 4 && showAnimation && (
                  <div className="absolute inset-0 pointer-events-none z-20" style={{ backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 40px, #334155 40px, #334155 50px)' }}></div>
              )}
              {currentLevel.id !== 6 && !(currentLevel.id === 4 && showAnimation) && (
                  <div className="absolute bottom-0 w-full h-1/3 opacity-30 z-0 pointer-events-none flex items-end">
                      {[...Array(8)].map((_, i) => (<div key={i} className="bg-slate-900 mx-1" style={{ height: `${Math.random() * 80 + 20}%`, width: '12%', }}></div>))}
                  </div>
              )}
              {currentLevel.id === 8 && (<div className="absolute top-1/2 left-1/2 -translate-x-1/2 w-48 h-32 bg-cyan-100 rounded-full blur-xl opacity-50 z-0"></div>)}
              {currentLevel.id === 6 && (
                  <div className="absolute inset-0 pointer-events-none overflow-hidden z-20">
                      <div className="absolute -top-10 -left-10 text-8xl text-green-900 opacity-60 -rotate-45 drop-shadow-lg">ğŸŒ¿</div>
                      <div className="absolute -bottom-10 -right-10 text-8xl text-green-900 opacity-60 rotate-12 drop-shadow-lg">ğŸŒ¿</div>
                  </div>
              )}
              <div className={`relative z-10 flex flex-col items-center transition-all duration-700 w-full h-full justify-center ${showAnimation ? 'scale-110' : 'scale-100'}`}>
                {currentLevel.id === 1 && (
                  <div className="relative flex flex-col items-center">
                     {showAnimation && (
                       <div className="absolute -top-16 bg-white border-2 border-slate-200 text-slate-800 px-4 py-2 rounded-2xl text-sm font-bold shadow-lg animate-fade-in z-50 whitespace-nowrap">
                         èŒ±è’‚è­¦å®˜ï¼Œå ±åˆ°ï¼
                         {/* Speech Bubble Tail */}
                         <div className="absolute -bottom-2 left-4 w-4 h-4 bg-white border-r-2 border-b-2 border-slate-200 rotate-45 transform translate-y-[-1px]"></div>
                       </div>
                     )}
                     <div className={`text-7xl ${showAnimation ? 'animate-bounce' : ''}`}>ğŸ°</div>
                  </div>
                )}
                {currentLevel.id === 2 && (<div className={`text-6xl transition-all duration-1000 relative ${showAnimation ? 'translate-x-0 translate-y-0' : 'translate-x-20 translate-y-12'}`}>
                     ğŸš“
                     <div className="absolute -top-8 left-0 text-xs text-blue-600 font-mono bg-white/80 px-1 rounded">{showAnimation ? 'x:0 y:0' : 'x:120 y:80'}</div>
                     <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-2 border-dashed border-red-500 rounded-full opacity-30 pointer-events-none ${showAnimation ? 'scale-0 opacity-0' : 'scale-100'}`}></div>
                </div>)}
                {currentLevel.id === 3 && (<div className="relative w-full h-full flex items-center justify-center">
                      <div className={`text-5xl absolute transition-all duration-75 ease-linear z-10`} style={showAnimation ? { left: `${autoMousePos.x}%`, top: `${autoMousePos.y}%`, transform: `translate(-50%, -50%) rotate(${rotation}deg)` } : {}}>ğŸš“</div>
                      {showAnimation && (
                        <div className="absolute z-20 transition-all duration-75 ease-linear pointer-events-none" style={{ left: `${autoMousePos.x}%`, top: `${autoMousePos.y}%`, transform: 'translate(-50%, -50%)' }}>
                            <div className="radar-pulse"></div>
                            <MapPin className="text-red-500 drop-shadow-lg relative z-10" size={28} fill="currentColor" />
                         </div>
                      )}
                </div>)}
                {currentLevel.id === 4 && (<div className="flex gap-24 items-center relative w-full justify-between px-8">
                      <div className={`text-7xl transition-transform duration-1000 ${showAnimation ? 'translate-x-32 relative z-50' : ''}`}>
                          ğŸ°{showAnimation && (<div className="absolute -top-12 left-0 bg-blue-600 text-white px-3 py-1 rounded-xl text-sm font-bold whitespace-nowrap animate-bounce z-50 shadow-lg">ç«™ä½ï¼</div>)}
                      </div>
                      <div className={`text-6xl relative transition-all duration-500 ${showAnimation ? 'scale-75 translate-y-4' : ''}`}>
                          ğŸ¦¦{!showAnimation && <span className="absolute bottom-0 -right-2 text-2xl">ğŸ§…</span>}
                          {showAnimation && <span className="absolute -left-4 bottom-0 text-4xl">ğŸ”—</span>}
                          {showAnimation && (<div className="absolute -top-8 left-1/2 -translate-x-1/2 pointer-events-none z-30">
                                  <div className="text-red-600 font-black text-2xl border-4 border-red-600 p-1 transform -rotate-12 opacity-100 animate-pulse whitespace-nowrap bg-white/80 backdrop-blur-sm">ARRESTED</div>
                              </div>)}
                      </div>
                </div>)}
                {currentLevel.id === 5 && (<div className="relative mt-20 mr-20"> 
                      <div className={`text-7xl ${showAnimation ? 'animate-pulse' : ''}`}>ğŸ°</div>
                      <div className="absolute top-4 -right-12 text-5xl animate-bounce delay-75">ğŸ­</div>
                      {showAnimation && (<div className="absolute -top-12 -right-20 flex flex-col gap-1 items-center z-50 w-max">
                           <div className="text-pink-500 font-bold text-lg animate-bounce drop-shadow-sm bg-white/50 px-2 rounded-full backdrop-blur-sm border border-pink-200">å•µï¼</div>
                           <div className="bg-orange-500 text-white px-2 py-0.5 rounded-full font-bold shadow-lg text-xs">è­‰æ“š +1</div>
                      </div>)}
                </div>)}
                {currentLevel.id === 6 && (<div className="w-full h-full relative flex items-center justify-center">
                      {showAnimation && (<div className="absolute inset-0 flex items-center justify-center z-0"><div className="text-white/80 font-bold text-5xl border-4 border-white/50 p-4 rounded-xl opacity-50 transform -rotate-6">SAFE ZONE</div></div>)}
                      <div className={`text-6xl absolute transition-all duration-1000 ${showAnimation ? 'right-[40%] scale-x-[-1]' : 'right-0'}`} style={{zIndex: 10}}>ğŸš“</div>
                      <div className="absolute right-0 top-0 h-full w-8 bg-yellow-400 flex flex-col items-center justify-center border-l-4 border-black/20 shadow-xl z-20"><div className="text-[10px] font-black tracking-widest -rotate-90 whitespace-nowrap opacity-50 text-yellow-900">BOUNDARY</div></div>
                      {!showAnimation && (<>
                           <div className="absolute top-1/2 right-16 -translate-y-1/2 text-red-500 font-bold animate-ping text-xl z-20 shadow-white drop-shadow-md">è­¦å‘Š!</div>
                           <div className="absolute top-1/2 right-32 -translate-y-14 text-xs text-slate-900 bg-white/90 px-2 py-1 rounded font-mono border border-slate-300">x:200 y:0</div>
                      </>)}
                </div>)}
                {currentLevel.id === 7 && (<div className="flex flex-col items-center gap-6 pr-32"> 
                    <div className="flex gap-8 items-end">
                        <div className="text-7xl relative">ğŸ°{showAnimation && <div className="absolute bottom-0 -right-4 text-3xl animate-pulse">ğŸ’¨</div>}</div>
                        <div className="text-7xl relative">ğŸ¦Š{showAnimation && (<div className="absolute top-0 -right-40 w-max bg-slate-800 text-green-400 p-2 rounded-lg text-xs font-mono animate-pulse z-50 shadow-lg border border-slate-600">ğŸ“¡ å‘¼å«æ”¯æ´...<div className="absolute bottom-2 -left-[6px] w-0 h-0 border-t-[6px] border-t-transparent border-r-[6px] border-r-slate-800 border-b-[6px] border-b-transparent"></div></div>)}</div>
                    </div>
                    {showAnimation && <div className="text-sm font-bold text-blue-600 bg-white px-3 py-1 rounded-full shadow">æœ€ä½³æ‹æª”æ¨¡å¼ï¼šå•Ÿå‹•</div>}
                </div>)}
                {currentLevel.id === 8 && (<div className="relative w-full h-full overflow-hidden">
                      <div className="absolute top-2 left-1/2 -translate-x-1/2 text-5xl z-10 drop-shadow-lg">ğŸ­<span className="text-xs absolute -bottom-4 left-1/2 -translate-x-1/2 w-max text-center font-bold text-white bg-black/50 rounded px-2 py-0.5">Mr. Big</span></div>
                      <div className={`absolute left-1/2 -translate-x-1/2 text-6xl transition-all duration-[2000ms] ease-in-out ${showAnimation ? 'top-20' : 'bottom-2'}`} style={{zIndex: 20}}>
                        ğŸš“{showAnimation && (<div className="absolute -top-12 -left-8 bg-white text-black px-2 py-1 rounded-lg text-xs font-bold whitespace-nowrap animate-bounce delay-1000 shadow-lg">å°±ä½å®Œç•¢</div>)}
                      </div>
                </div>)}
                {currentLevel.id === 9 && (<div className="w-full h-full relative flex items-center justify-center">
                      <div className={`text-6xl absolute transition-all duration-2000 ease-linear ${showAnimation ? 'translate-x-12 translate-y-12' : '-translate-x-20 -translate-y-16'}`} style={{zIndex: 10}}>ğŸš‹</div>
                      <div className="text-6xl absolute translate-x-12 translate-y-12" style={{zIndex: 1}}>ğŸš§</div>
                      {showAnimation && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl text-white font-black bg-red-600 px-6 py-2 rounded shadow-2xl animate-pulse transform rotate-12 z-20">STOP!</div>}
                </div>)}
                {currentLevel.id === 10 && (<div className="w-full h-full relative flex flex-col items-center justify-center overflow-hidden bg-slate-900">
                      <div className="absolute inset-0 bg-gradient-to-t from-purple-900/80 via-transparent to-transparent z-0"></div>
                      {showAnimation && (<><div className="absolute top-0 left-1/4 w-24 h-full bg-yellow-400/20 rotate-12 blur-xl origin-top animate-pulse z-0"></div><div className="absolute top-0 right-1/4 w-24 h-full bg-blue-400/20 -rotate-12 blur-xl origin-top animate-pulse delay-75 z-0"></div></>)}
                      <div className={`relative z-10 flex flex-col items-center justify-center transition-all duration-300 ${showAnimation ? 'scale-125' : 'scale-100'}`}>
                         <div className={`text-9xl relative z-20 ${showAnimation ? 'animate-bounce' : ''}`}>
                           ğŸ¦Œ{showAnimation && (<div className="absolute -top-4 left-1/2 -translate-x-1/2 text-5xl drop-shadow-md transition-all duration-300">{['ğŸ•¶ï¸', 'ğŸ‘’', 'ğŸ‘‘', 'ğŸ©', 'ğŸ§', 'â­', 'ğŸ€', 'ğŸ‘“', 'å‹', 'ğŸŒ¹'][costumeFrame % 10]}</div>)}
                         </div>
                         <div className={`absolute top-1/2 -right-8 text-4xl z-30 -translate-y-1/2 ${showAnimation ? 'animate-pulse' : ''}`}>ğŸ¤</div>
                      </div>
                      {showAnimation && (<div className="absolute top-10 w-full text-center z-50">
                              <div className="text-yellow-300 text-3xl font-black drop-shadow-[0_0_10px_rgba(234,179,8,0.8)] animate-pulse">â™« Try Everything â™«</div>
                              <div className="mt-48"><span className="bg-white/90 text-purple-700 text-sm font-bold px-4 py-2 rounded-full inline-block shadow-xl animate-bounce border-2 border-purple-200">Codepodia Forever!</span></div>
                         </div>)}
                </div>)}
              </div>
              {!showAnimation && gameState === 'playing' && (<div className="absolute bottom-2 right-2 text-white/70 text-xs font-mono bg-black/20 px-2 rounded uppercase">Waiting...</div>)}
            </div>
          );
        };

        if (gameState === 'intro') {
          return (
            <div className="min-h-screen bg-[url('https://files.catbox.moe/p7beln.jpg')] bg-cover bg-center text-slate-900 flex flex-col items-center justify-center p-4 font-sans overflow-y-auto relative">
              <div className="max-w-xl w-full bg-black/30 backdrop-blur-sm rounded-3xl shadow-2xl p-8 flex flex-col items-center relative z-10 text-center space-y-6 border border-white/20">
                <div className="flex items-center gap-4"><span className="text-6xl animate-bounce">ğŸ°</span><span className="text-6xl animate-bounce delay-100">ğŸ¦Š</span></div>
                <h1 className="text-5xl font-black text-white tracking-wider drop-shadow-md leading-tight pb-2">å‹•ç‰©æ–¹ç¨‹å¼<br/><span className="text-4xl">è­¦æ ¡ç¨‹å¼ç‰¹è¨“</span></h1>
                <p className="text-lg text-white leading-relaxed font-bold drop-shadow-md">æ­¡è¿ä¾†åˆ° <b>å‹•ç‰©æ–¹ç¨‹å¼ è­¦å±€</b>ï¼<br/>æˆ‘æ˜¯<b>èŒ±è’‚</b>ï¼Œæˆ‘å€‘éœ€è¦ä½ çš„å¹«åŠ©ä¾†è§£æ±ºåŸå¸‚è£¡çš„æ£˜æ‰‹æ¡ˆä»¶ã€‚<br/>é€™è£¡å…±æœ‰ 10 å€‹ä»»å‹™ï¼Œ<br/><b>åªæœ‰æœ€è°æ˜çš„ç¨‹å¼è­¦å®˜æ‰èƒ½å®ŒæˆæŒ‘æˆ°ï¼</b></p>
                <div className="flex flex-col gap-3 items-center w-full mt-2">
                  <div className="relative w-full"><User className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-700" size={20}/><input type="text" placeholder="è«‹è¼¸å…¥è­¦å“¡ä»£è™Ÿ (åå­—)" value={playerName} onChange={(e) => setPlayerName(e.target.value)} className="w-full pl-12 pr-6 py-4 rounded-xl bg-white/80 border-2 border-white/50 text-slate-900 text-lg focus:outline-none focus:border-blue-800 focus:ring-2 focus:ring-blue-800/20 transition-all placeholder-slate-600 font-bold backdrop-blur-sm shadow-inner" /></div>
                  <button onClick={startGame} disabled={!playerName.trim()} className={`w-full bg-gradient-r from-blue-600 to-indigo-700 text-white text-xl font-black py-4 px-12 rounded-xl shadow-lg flex items-center justify-center gap-3 border border-white/20 ${!playerName.trim() ? 'opacity-50 cursor-not-allowed grayscale' : 'hover:brightness-110 transform transition hover:scale-[1.02] active:scale-95'}`}><Play fill="currentColor" /> é–‹å§‹åŸ·å‹¤</button>
                </div>
              </div>
            </div>
          );
        }

        if (gameState === 'complete') {
          const isSuccess = totalScore >= 60;
          return (
            <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-4 overflow-y-auto">
              <div className="text-center space-y-6 animate-fade-in max-w-2xl w-full">
                <div className="relative h-64 w-full bg-slate-800 rounded-2xl overflow-hidden border-4 border-slate-700 mb-6 flex items-center justify-center">{isSuccess ? (<img src="https://files.catbox.moe/3ps5aa.jpg" alt="Mission Success" className="w-full h-full object-cover" />) : (<img src="https://files.catbox.moe/nrv2yz.jpg" alt="Mission Failed" className="w-full h-full object-cover" />)}</div>
                <h2 className="text-4xl font-bold text-white">{isSuccess ? "æ¡ˆä»¶ç ´ç²ï¼æ¦®è€€æ™‚åˆ»" : "ä»»å‹™å¤±æ•—..."}</h2>
                <div className="bg-white/10 p-8 rounded-2xl backdrop-blur-sm border border-white/20">
                  <div className="text-xl mb-2 flex items-center justify-center gap-2"><User size={20} className="text-yellow-400"/>è­¦å“¡ï¼š<span className="font-bold text-yellow-400">{playerName || "æœªå…·å"}</span></div>
                  <div className="text-gray-400 mb-4 text-sm uppercase tracking-widest">Performance Review</div>
                  <div className={`text-6xl font-black ${isSuccess ? 'text-green-400' : 'text-red-400'} font-mono`}>{totalScore} <span className="text-2xl text-white">/ 100</span></div>
                  <p className="mt-6 text-lg text-slate-200">{isSuccess ? "å¤ªæ£’äº†ï¼è »ç‰›å±€é•·å°ä½ çš„è¡¨ç¾åˆ®ç›®çœ‹ï¼Œå‹•ç‰©æ–¹ç¨‹å¼æ¢å¾©äº†å’Œå¹³ï¼ğŸš“âœ¨" : "ç³Ÿç³•ï¼åˆ†æ•¸ä¸è¶³ã€‚ä½ éœ€è¦é‡æ–°å›åˆ°è­¦æ ¡å—è¨“äº†... ğŸ“š"}</p>
                </div>
                <button onClick={startGame} className="mt-8 px-8 py-3 bg-white text-slate-900 rounded-full font-bold hover:bg-slate-200 transition-colors flex items-center gap-2 mx-auto"><RotateCw size={18}/> é‡æ–°æŒ‘æˆ°</button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen bg-slate-50 flex flex-col font-sans text-slate-800 md:overflow-hidden">
            <header className="bg-slate-900 text-white p-3 shadow-md flex justify-between items-center sticky top-0 z-50 shrink-0 border-b-4 border-blue-500">
              <div className="flex items-center gap-3"><div className="bg-blue-600 p-2 rounded-lg shadow-inner border border-blue-400"><Star fill="currentColor" className="text-yellow-300" size={20}/></div><div><h1 className="text-lg font-bold tracking-wide">å‹•ç‰©æ–¹ç¨‹å¼ï¼šè­¦æ ¡ç‰¹è¨“</h1><div className="text-xs text-blue-300 flex items-center gap-1"><Map size={10}/> Level {currentLevel.id}: {currentLevel.title}</div></div></div>
              <div className="flex items-center gap-6"><div className="flex flex-col items-end">{playerName && <span className="text-xs font-bold text-slate-400 uppercase flex items-center gap-1"><User size={10}/> Officer {playerName}</span>}<div className="flex items-baseline gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700"><span className="text-[10px] text-slate-400 uppercase tracking-wider">Score</span><span className="font-bold text-xl text-yellow-400 font-mono">{totalScore}</span></div></div></div>
            </header>
            <main className="flex-1 overflow-y-auto md:overflow-hidden p-3 grid grid-cols-12 gap-3 max-w-screen-2xl mx-auto w-full">
              <div className="col-span-12 md:col-span-3 flex flex-col gap-3 h-auto md:h-full overflow-hidden">
                <div className="bg-white p-4 rounded-xl shadow-sm border-l-8 border-blue-500 shrink-0 max-h-[300px] md:max-h-[40%] overflow-y-auto">
                  <div className="flex justify-between items-start mb-2"><h2 className="text-base font-bold text-slate-800 flex items-center gap-2"><AlertCircle size={18} className="text-blue-500"/> ä»»å‹™ç°¡å ±</h2><button onClick={() => setShowHint(!showHint)} className="flex items-center gap-1 text-[10px] font-bold bg-yellow-50 text-yellow-700 px-2 py-1 rounded hover:bg-yellow-100 transition border border-yellow-200"><Lightbulb size={12} fill={showHint ? "currentColor" : "none"} />{showHint ? "éš±è—æç¤º" : "æ±‚æ•‘"}</button></div>
                  <p className="text-slate-600 mb-3 text-sm leading-relaxed">{getDynamicDescription(currentLevel.description)}</p>
                  {showHint && (<div className="mt-2 bg-yellow-50 p-2 rounded text-xs text-yellow-800 border border-yellow-200 animate-fade-in flex gap-2"><span className="shrink-0 mt-0.5">ğŸ’¡</span><span>{currentLevel.hint}</span></div>)}
                </div>
                <div className="bg-slate-100 rounded-xl p-3 overflow-y-auto border border-slate-200 flex-1 min-h-[250px] md:min-h-0 flex flex-col shadow-inner">
                  <h3 className="font-bold text-slate-500 mb-3 flex items-center gap-2 shrink-0 text-sm uppercase tracking-wider"><Layers size={14}/> æŒ‡ä»¤ç©æœ¨</h3>
                  <div className="space-y-1.5 flex-1 overflow-y-auto pr-1">{shuffledBlocks.map((block) => (<Block key={block.id} block={block} onClick={() => addToScript(block)} isSelected={false} isContainer={isContainerBlock(block.id)} />))}</div>
                   <div className="text-[10px] text-slate-400 text-center mt-2 pt-2 border-t border-slate-200">é»æ“Šç©æœ¨åŠ å…¥ç·¨è¼¯å€</div>
                </div>
              </div>
              <div className="col-span-12 md:col-span-5 flex flex-col min-h-[300px] md:h-full overflow-hidden bg-white rounded-xl shadow-sm border border-slate-200 relative">
                  <div className="flex justify-between items-center p-3 border-b border-slate-100 shrink-0 bg-slate-50"><h3 className="font-bold text-slate-700 flex items-center gap-2 text-sm"><ImageIcon size={16} className="text-slate-400"/> ç¨‹å¼ç·¨è¼¯å€</h3><button onClick={clearScript} className="text-xs text-red-500 hover:text-red-700 font-medium px-2 py-1 rounded hover:bg-red-50 disabled:opacity-30 disabled:hover:text-red-500 transition-colors" disabled={gameState === 'success'}><RotateCw size={12} className="inline mr-1"/>é‡ç½®</button></div>
                  <div className="flex-1 p-4 overflow-y-auto coding-area-bullseye min-h-[200px]">
                     {scriptArea.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-300"><div className="w-16 h-16 border-4 border-dashed border-slate-200 rounded-lg flex items-center justify-center mb-2"><Move size={32} className="opacity-50" /></div><p className="text-xs font-bold uppercase tracking-wide">Area Empty</p></div>) : (
                       <div className="space-y-0 pb-10">{renderedScript.map((block, index) => (<div key={`${block.id}-${index}`} className="relative group">
                             {isHatBlock(block.id) && index > 0 && isMultiScriptLevel && (
                               <div className="h-8 border-b-2 border-dashed border-slate-300 w-full mb-4 mt-6 relative opacity-50">
                                 <span className="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-slate-50 px-2 text-[10px] text-slate-400 font-mono">NEW SCRIPT</span>
                               </div>
                             )}
                             {block.indentLevel > 0 && (<div className="absolute top-0 bottom-0 border-l-4 border-slate-300 opacity-30 z-0" style={{ left: `${(block.indentLevel * 16) - 10}px` }}></div>)}
                             <div style={{ marginLeft: `${block.indentLevel * 16}px` }}><Block block={block} onClick={() => {}} isSelected={false} isContainer={block.isContainer} /></div>
                             {gameState === 'playing' && (<button onClick={() => removeFromScript(index)} className="absolute right-2 top-2 text-slate-400 opacity-0 group-hover:opacity-100 hover:text-red-500 hover:scale-110 font-bold bg-white rounded-full w-5 h-5 flex items-center justify-center shadow-md z-20 transition-all">Ã—</button>)}
                             {index < scriptArea.length - 1 && !block.isContainer && !isHatBlock(scriptArea[index+1].id) && (<div className="h-1 w-3 bg-gray-300 ml-4 -mt-1 mb-0 rounded-b-sm opacity-50" style={{ marginLeft: `${(block.indentLevel * 16) + 16}px` }}></div>)}
                           </div>))}</div>)}
                  </div>
              </div>
              <div className="col-span-12 md:col-span-4 flex flex-col gap-3 h-auto md:h-full overflow-visible md:overflow-hidden">
                <div className="bg-slate-800 rounded-xl shadow-lg border-[3px] border-slate-700 shrink-0 h-auto md:h-[50%] flex flex-col relative overflow-hidden group">
                   <div className="absolute top-2 left-2 z-20 bg-black/60 backdrop-blur-sm px-2 py-1 rounded text-[10px] text-white flex items-center gap-1 font-mono border border-white/10"><Flag size={10} className="text-green-400"/> LIVE PREVIEW</div>
                   <div className="h-[300px] md:flex-1 relative bg-black">{renderGameStage()}</div>
                   <div className="bg-slate-800 p-3 flex justify-center shrink-0 border-t border-slate-700">
                      <button onClick={checkAnswer} disabled={scriptArea.length === 0 || gameState === 'success'} className={`w-full py-3 md:py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 transition-all text-sm uppercase tracking-wide ${gameState === 'success' ? 'bg-green-600 text-white cursor-default' : 'bg-green-500 hover:bg-green-400 text-white shadow-lg shadow-green-900/50 active:translate-y-0.5'} disabled:opacity-50 disabled:cursor-not-allowed`}><Play size={16} fill="currentColor" /> {gameState === 'success' ? 'åŸ·è¡Œå®Œç•¢' : 'åŸ·è¡Œ (Run Code)'}</button>
                   </div>
                </div>
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden relative min-h-[250px] md:min-h-0">
                   {!feedback && (<div className="flex-1 flex flex-col items-center justify-center text-slate-300 p-4 text-center"><MessageCircle size={32} className="mb-3 opacity-30"/><p className="text-xs font-bold text-slate-400 uppercase tracking-widest">System Ready</p><p className="text-sm mt-1">ç­‰å¾…åŸ·è¡ŒæŒ‡ä»¤...</p></div>)}
                   {feedback && (<div className={`absolute inset-0 flex flex-col p-4 animate-fade-in ${gameState === 'success' ? 'bg-green-50' : 'bg-red-50'}`}>
                          <div className="flex items-center gap-3 mb-1 justify-center shrink-0">
                            {gameState === 'success' ? <Trophy className="text-green-500" size={16}/> : <AlertCircle className="text-red-500" size={16}/>}
                            <h3 className={`font-black text-lg md:text-xl ${gameState === 'success' ? 'text-green-800' : 'text-red-700'}`}>
                              {gameState === 'success' ? "MISSION SUCCESS" : "ERROR DETECTED"}
                            </h3>
                          </div>
                          <div className="text-center mb-2 text-sm font-bold text-slate-700 leading-snug">{feedback}</div>
                          <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 mb-2 min-h-0">
                            {gameState === 'success' && (
                              <div className="bg-white p-3 rounded-xl border-2 border-green-200 text-left shadow-sm">
                                <div className="flex items-center gap-2 font-black text-green-700 mb-1 pb-1 border-b-2 border-green-50 text-xs md:text-sm uppercase tracking-widest">
                                  <BookOpen size={16}/> Coding Concept
                                </div>
                                <div className="leading-relaxed text-slate-800 text-xs md:text-sm font-medium">{currentLevel.explanation}</div>
                              </div>
                            )}
                          </div>
                          <div className="mt-auto flex justify-center shrink-0 pb-1">
                            {gameState === 'success' ? (
                              <button onClick={nextLevel} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-2 md:py-3 rounded-full font-black text-base md:text-lg shadow-xl flex items-center gap-3 transition-all hover:scale-105 active:scale-95">
                                {currentLevelIdx === LEVELS.length - 1 ? "æŸ¥çœ‹æˆç¸¾" : "ä¸‹ä¸€é—œ"} 
                                {currentLevelIdx === LEVELS.length - 1 ? <Trophy size={18} /> : <ArrowRight size={18} />}
                              </button>
                            ) : (
                              <button onClick={() => setFeedback("")} className="text-slate-600 text-sm md:text-base font-black hover:text-slate-900 uppercase tracking-widest py-3 px-8 hover:bg-slate-100 rounded-full transition-all border-2 border-slate-200">
                                Try Again
                              </button>
                            )}
                          </div>
                      </div>)}
                </div>
              </div>
            </main>
          </div>
        );
      }

      const rootElement = document.getElementById('root');
      if (!rootElement) throw new Error("Could not find root element to mount to");
      const root = ReactDOM.createRoot(rootElement);
      root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  </body>
</html>
